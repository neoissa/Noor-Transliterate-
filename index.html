<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Noor Transliterate ğŸŒŸ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600&family=Amiri:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
            min-height: 100vh;
        }
        .arabic-text {
            font-family: 'Amiri', serif;
            direction: rtl;
        }
        .keyboard-key {
            transition: all 0.1s cubic-bezier(0.4, 0, 0.2, 1);
            user-select: none;
            touch-action: manipulation;
        }
        .keyboard-key:active {
            transform: translateY(2px);
            opacity: 0.8;
        }
        
        /* Keyboard Themes */
        .kb-theme-white .keyboard-key {
            background-color: #ffffff;
            color: #1e293b;
            border-bottom: 4px solid #e2e8f0;
        }
        .kb-theme-black .keyboard-key {
            background-color: #1e293b;
            color: #f8fafc;
            border-bottom: 4px solid #0f172a;
        }
        .kb-theme-black {
            background-color: #0f172a !important;
        }

        .glass-morphism {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.4);
        }
        .active-tab {
            background-color: #059669;
            color: white;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }
        .loading-spinner {
            border: 3px solid rgba(0, 0, 0, 0.1);
            width: 24px;
            height: 24px;
            border-radius: 50%;
            border-left-color: #10b981;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        select {
            appearance: none;
            background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");
            background-repeat: no-repeat;
            background-position: right 0.5rem center;
            background-size: 1em;
        }
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        .ltr { direction: ltr; text-align: left; }
        .rtl { direction: rtl; text-align: right; }
    </style>
</head>
<body class="p-3 sm:p-4 md:p-6 lg:p-8 text-slate-800">

    <div class="max-w-7xl mx-auto relative">
        
        <!-- Header -->
        <header class="text-center mb-8 pt-4">
            <div class="flex justify-center mb-3">
                <div class="p-3 bg-white rounded-2xl shadow-sm border border-slate-100">
                    <svg width="50" height="50" viewBox="0 0 100 100" fill="none" xmlns="http://www.w3.org/2000/svg" class="text-emerald-600">
                        <path d="M50 10L15 25V75L50 90L85 75V25L50 10Z" stroke="currentColor" stroke-width="4" stroke-linejoin="round" fill="white"/>
                        <path d="M50 20V80M25 35C25 35 35 40 50 40C65 40 75 35 75 35M25 50C25 50 35 55 50 55C65 55 75 50 75 50M25 65C25 65 35 70 50 70C65 70 75 65 75 65" stroke="currentColor" stroke-width="3" stroke-linecap="round"/>
                    </svg>
                </div>
            </div>
            <h1 class="text-3xl sm:text-4xl font-extrabold text-slate-800 tracking-tight">Noor Transliterate ğŸŒŸ</h1>
            <p class="text-slate-500 mt-2 font-medium italic">100% Offline Intelligence & Embedded Database</p>
        </header>

        <!-- Mode Toggle -->
        <div class="flex justify-center mb-8">
            <div class="inline-flex rounded-2xl shadow-sm bg-white p-1.5 border border-slate-200">
                <button id="modeStandard" onclick="setMode('standard')" class="px-5 sm:px-8 py-2.5 rounded-xl text-xs sm:text-sm font-bold transition-all active-tab">Standard</button>
                <button id="modeArabizi" onclick="setMode('arabizi')" class="px-5 sm:px-8 py-2.5 rounded-xl text-xs sm:text-sm font-bold transition-all text-slate-500 hover:bg-slate-50">Arabizi (3rb)</button>
                <button id="modeQuran" onclick="setMode('quran')" class="px-5 sm:px-8 py-2.5 rounded-xl text-xs sm:text-sm font-bold transition-all text-slate-500 hover:bg-slate-50 flex items-center gap-1">ğŸ“– Quran Search</button>
            </div>
        </div>

        <!-- Utility Bar -->
        <div class="flex flex-wrap justify-center gap-4 mb-10">
            <button onclick="autoCorrectText()" class="px-5 py-3 bg-emerald-600 text-white rounded-full shadow-lg text-sm font-bold hover:bg-emerald-700 transition-all flex items-center gap-2" title="Checks embedded dictionary for proper Harakat"><span>âœ¨ Auto-Correct Harakat</span></button>
            <button onclick="localReflectText()" class="px-5 py-3 bg-white border border-blue-200 text-blue-700 rounded-full shadow-sm text-sm font-bold hover:bg-blue-50 transition-all flex items-center gap-2"><span>ğŸ’¡ Offline Reflection</span></button>
            <button onclick="speakTextNative()" class="px-5 py-3 bg-slate-800 text-white rounded-full shadow-sm text-sm font-bold hover:bg-slate-700 transition-all flex items-center gap-2" title="Uses free native browser voice"><span>ğŸ”Š Speak Text</span></button>
        </div>

        <!-- Loading Indicator -->
        <div id="apiLoading" class="hidden flex justify-center mb-8">
            <div class="flex items-center gap-3 bg-white px-8 py-4 rounded-2xl shadow-xl border border-slate-100">
                <div class="loading-spinner"></div>
                <span class="text-sm font-semibold text-slate-600 italic" id="apiLoadingText">Fetching Data...</span>
            </div>
        </div>

        <div class="space-y-8">
            <!-- Quran Pick UI -->
            <div id="quranPickContainer" class="hidden glass-morphism rounded-3xl p-6 md:p-8 shadow-xl border-t-8 border-emerald-600 space-y-6">
                <div class="flex items-center gap-3 mb-2 text-emerald-900">
                    <span class="text-2xl">ğŸ“–</span>
                    <span class="text-lg font-extrabold uppercase tracking-widest">Quran Verse Picker (Public Data)</span>
                </div>
                <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
                    <div class="flex flex-col gap-1.5">
                        <label class="text-[11px] font-black text-slate-400 uppercase tracking-wider ml-1">By Juz</label>
                        <select id="pickJuz" onchange="handleJuzChange()" class="p-3 rounded-xl border border-slate-200 text-sm bg-white outline-none focus:ring-2 focus:ring-emerald-500 transition-all"></select>
                    </div>
                    <div class="flex flex-col gap-1.5">
                        <label class="text-[11px] font-black text-slate-400 uppercase tracking-wider ml-1">By Surah</label>
                        <select id="pickSurah" onchange="handleSurahChange()" class="p-3 rounded-xl border border-slate-200 text-sm bg-white outline-none focus:ring-2 focus:ring-emerald-500 transition-all"></select>
                    </div>
                    <div class="flex flex-col gap-1.5">
                        <label class="text-[11px] font-black text-slate-400 uppercase tracking-wider ml-1">By Ayah</label>
                        <select id="pickAyah" onchange="handleAyahChange()" class="p-3 rounded-xl border border-slate-200 text-sm bg-white outline-none focus:ring-2 focus:ring-emerald-500 transition-all"></select>
                    </div>
                </div>
                <div class="flex gap-3">
                    <input type="text" id="quranKeyword" placeholder="Search ref (e.g. '2:255') or keyword..." class="flex-1 p-4 rounded-2xl border border-slate-200 text-sm outline-none focus:ring-2 focus:ring-emerald-500 shadow-inner" onkeypress="if(event.key==='Enter') handleUnifiedSearch()">
                    <button onclick="handleUnifiedSearch()" class="px-8 py-4 bg-slate-800 text-white rounded-2xl text-sm font-black hover:bg-slate-900 transition-all shadow-md">Search</button>
                </div>
                <div id="quranResults" class="hidden max-h-60 overflow-y-auto space-y-3 mt-4 pr-1 custom-scrollbar"></div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 sm:gap-8">
                <!-- Input Card -->
                <div class="glass-morphism rounded-3xl p-6 md:p-8 shadow-xl border-b-8 border-emerald-500 flex flex-col">
                    <div class="flex justify-between items-center mb-4">
                        <label id="inputLabel" class="text-xs sm:text-sm font-black text-slate-700 uppercase tracking-widest">Input Master Script</label>
                        <div class="flex gap-3">
                            <button onclick="pasteText()" class="text-[11px] font-black text-emerald-600 hover:text-emerald-700 uppercase flex items-center gap-1.5">ğŸ“‹ Paste</button>
                            <span class="text-slate-300">|</span>
                            <button onclick="clearText('input')" class="text-[11px] font-black text-red-500 hover:text-red-700 uppercase">Clear</button>
                        </div>
                    </div>
                    <textarea 
                        id="mainInput" 
                        class="w-full h-40 sm:h-56 p-5 rounded-2xl border border-slate-200 focus:ring-4 focus:ring-emerald-500/20 outline-none transition-all text-2xl sm:text-3xl shadow-inner bg-white/50"
                        placeholder="Type here..."
                    ></textarea>
                </div>

                <!-- Output Card -->
                <div class="glass-morphism rounded-3xl p-6 md:p-8 shadow-xl border-b-8 border-blue-500 flex flex-col space-y-6 relative">
                    
                    <div id="arabicResultSection" class="animate-in fade-in slide-in-from-top-2">
                         <div class="flex justify-between items-center mb-2">
                            <label class="text-[11px] font-black text-slate-500 uppercase tracking-widest">Arabic Script Result</label>
                            <button onclick="copyText('outputArabicEditable')" class="text-[10px] font-black text-emerald-600 hover:underline uppercase transition-all">Copy ğŸ“‹</button>
                        </div>
                        <textarea id="outputArabicEditable" class="w-full p-4 rounded-2xl bg-white border border-slate-200 text-2xl sm:text-3xl arabic-text shadow-inner min-h-[120px] rtl" dir="rtl" oninput="updateTranslitFromArabicEdit()"></textarea>
                    </div>

                    <div>
                        <div class="flex justify-between items-center mb-2">
                            <label class="text-[11px] font-black text-slate-500 uppercase tracking-widest">Formal Transliteration</label>
                            <button onclick="copyText('output1')" class="text-[10px] font-black text-blue-600 hover:underline uppercase transition-all">Copy ğŸ“‹</button>
                        </div>
                        <textarea id="output1" class="w-full p-4 rounded-2xl bg-white/60 border border-slate-200 text-lg italic leading-relaxed shadow-inner min-h-[100px] ltr" dir="ltr" placeholder="Phonetic output appears here..."></textarea>
                    </div>

                    <div id="translationContainer" class="hidden">
                        <label class="text-[11px] font-black text-slate-500 uppercase tracking-widest block mb-2">English Meaning (Public API)</label>
                        <div id="outputTranslation" class="w-full p-5 rounded-2xl bg-purple-50/80 border border-purple-100 text-base sm:text-lg leading-relaxed text-slate-800 ltr italic" dir="ltr"></div>
                    </div>

                    <!-- Local Knowledge Base Container -->
                    <div id="aiInsightsContainer" class="hidden mt-2 p-6 rounded-2xl bg-blue-50 border border-blue-100 shadow-sm animate-in zoom-in-95 duration-300">
                        <div class="flex justify-between items-start mb-3">
                            <span class="text-[11px] font-black text-blue-800 uppercase tracking-widest italic flex items-center gap-2">ğŸ“š Local Dictionary Insight</span>
                            <button onclick="document.getElementById('aiInsightsContainer').classList.add('hidden')" class="text-blue-400 hover:text-blue-600 text-lg">âœ•</button>
                        </div>
                        <div id="aiInsightsContent" class="text-sm sm:text-base text-blue-900 leading-relaxed italic ltr" dir="ltr"></div>
                    </div>

                    <div id="copyBadge" class="hidden text-center text-emerald-600 text-xs font-black animate-bounce">Copied successfully! âœ…</div>
                </div>
            </div>

            <!-- Keyboard Section -->
            <div id="keyboardSection" class="glass-morphism rounded-3xl p-6 md:p-8 shadow-xl border-b-8 border-slate-400 overflow-hidden transition-all duration-300">
                <div class="flex items-center justify-between mb-5 border-b border-slate-100 pb-3">
                    <div class="flex items-center gap-3 text-slate-700">
                        <span class="text-2xl">âŒ¨ï¸</span>
                        <span class="text-sm font-black uppercase tracking-widest">Arabic Virtual Keyboard</span>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="setKeyboardTheme('white')" class="w-8 h-8 rounded-full bg-white border border-slate-300 shadow-sm" title="White Theme"></button>
                        <button onclick="setKeyboardTheme('black')" class="w-8 h-8 rounded-full bg-slate-800 shadow-sm" title="Black Theme"></button>
                    </div>
                </div>
                <div id="keyboardGrid" class="grid grid-cols-6 sm:grid-cols-10 md:grid-cols-12 lg:grid-cols-14 gap-2 p-1"></div>
            </div>
        </div>
        
        <footer class="mt-12 sm:mt-16 text-center text-slate-400 text-xs space-y-3 font-medium">
            <p>â€œAnd We have certainly made the Quran easy for remembrance...â€ (54:17)</p>
            <p>Â© Noor Transliterate â€¢ Zero-API Architecture</p>
        </footer>
    </div>

    <script>
        let currentMode = 'standard';
        let surahData = [];

        const mainInput = document.getElementById('mainInput');
        const output1 = document.getElementById('output1');
        const outputArabicEditable = document.getElementById('outputArabicEditable');
        const arabicResultSection = document.getElementById('arabicResultSection');
        const translationContainer = document.getElementById('translationContainer');
        const outputTranslation = document.getElementById('outputTranslation');
        const inputLabel = document.getElementById('inputLabel');
        const apiLoading = document.getElementById('apiLoading');
        const quranResults = document.getElementById('quranResults');
        const keyboardGrid = document.getElementById('keyboardGrid');
        const keyboardSection = document.getElementById('keyboardSection');
        const aiInsightsContainer = document.getElementById('aiInsightsContainer');
        const aiInsightsContent = document.getElementById('aiInsightsContent');

        // --- THE EMBEDDED DATABASE (v5.0) ---
        // Maps unvoweled text / Arabizi to perfectly voweled (Harakat) Arabic strings.
        const embeddedDictionary = {
            // Arabizi to Arabic Match
            "bismillah": "Ø¨ÙØ³Ù’Ù…Ù Ø§Ù„Ù„ÙÙ‘Ù‡Ù",
            "alhamdulillah": "Ø§Ù„Ù’Ø­ÙÙ…Ù’Ø¯Ù Ù„ÙÙ„ÙÙ‘Ù‡Ù",
            "subhanallah": "Ø³ÙØ¨Ù’Ø­ÙØ§Ù†Ù Ø§Ù„Ù„ÙÙ‘Ù‡Ù",
            "allahuakbar": "Ø§Ù„Ù„ÙÙ‘Ù‡Ù Ø£ÙÙƒÙ’Ø¨ÙØ±Ù",
            "salam": "Ø³ÙÙ„ÙØ§Ù…",
            "assalamualaikum": "Ø§Ù„Ø³ÙÙ‘Ù„ÙØ§Ù…Ù Ø¹ÙÙ„ÙÙŠÙ’ÙƒÙÙ…Ù’",
            "salamalaykum": "Ø§Ù„Ø³ÙÙ‘Ù„ÙØ§Ù…Ù Ø¹ÙÙ„ÙÙŠÙ’ÙƒÙÙ…Ù’",
            "mashallah": "Ù…ÙØ§ Ø´ÙØ§Ø¡Ù Ø§Ù„Ù„ÙÙ‘Ù‡Ù",
            "inshallah": "Ø¥ÙÙ†Ù’ Ø´ÙØ§Ø¡Ù Ø§Ù„Ù„ÙÙ‘Ù‡Ù",
            "astaghfirullah": "Ø£ÙØ³Ù’ØªÙØºÙ’ÙÙØ±Ù Ø§Ù„Ù„ÙÙ‘Ù‡Ù",
            "allah": "Ø§Ù„Ù„ÙÙ‘Ù‡Ù",
            "muhammad": "Ù…ÙØ­ÙÙ…ÙÙ‘Ø¯ÙŒ",
            "ali": "Ø¹ÙÙ„ÙÙŠÙŒÙ‘",
            "hasan": "Ø­ÙØ³ÙÙ†ÙŒ",
            "husayn": "Ø­ÙØ³ÙÙŠÙ’Ù†ÙŒ",
            "hussain": "Ø­ÙØ³ÙÙŠÙ’Ù†ÙŒ",
            "fatima": "ÙÙØ§Ø·ÙÙ…ÙØ©Ù",
            "zahra": "Ø§Ù„Ø²ÙÙ‘Ù‡Ù’Ø±ÙØ§Ø¡Ù",
            "quran": "Ù‚ÙØ±Ù’Ø¢Ù†",
            "dua": "Ø¯ÙØ¹ÙØ§Ø¡",
            "salat": "ØµÙÙ„ÙØ§Ø©",
            "zakat": "Ø²ÙÙƒÙØ§Ø©",

            // Unvoweled Arabic to Voweled Arabic Match
            "Ø¨Ø³Ù… Ø§Ù„Ù„Ù‡": "Ø¨ÙØ³Ù’Ù…Ù Ø§Ù„Ù„ÙÙ‘Ù‡Ù",
            "Ø§Ù„Ø­Ù…Ø¯ Ù„Ù„Ù‡": "Ø§Ù„Ù’Ø­ÙÙ…Ù’Ø¯Ù Ù„ÙÙ„ÙÙ‘Ù‡Ù",
            "Ø³Ø¨Ø­Ø§Ù† Ø§Ù„Ù„Ù‡": "Ø³ÙØ¨Ù’Ø­ÙØ§Ù†Ù Ø§Ù„Ù„ÙÙ‘Ù‡Ù",
            "Ø§Ù„Ù„Ù‡ Ø§ÙƒØ¨Ø±": "Ø§Ù„Ù„ÙÙ‘Ù‡Ù Ø£ÙÙƒÙ’Ø¨ÙØ±Ù",
            "Ø§Ù„Ø³Ù„Ø§Ù… Ø¹Ù„ÙŠÙƒÙ…": "Ø§Ù„Ø³ÙÙ‘Ù„ÙØ§Ù…Ù Ø¹ÙÙ„ÙÙŠÙ’ÙƒÙÙ…Ù’",
            "Ù…Ø§ Ø´Ø§Ø¡ Ø§Ù„Ù„Ù‡": "Ù…ÙØ§ Ø´ÙØ§Ø¡Ù Ø§Ù„Ù„ÙÙ‘Ù‡Ù",
            "Ø§Ù† Ø´Ø§Ø¡ Ø§Ù„Ù„Ù‡": "Ø¥ÙÙ†Ù’ Ø´ÙØ§Ø¡Ù Ø§Ù„Ù„ÙÙ‘Ù‡Ù",
            "Ø¥Ù† Ø´Ø§Ø¡ Ø§Ù„Ù„Ù‡": "Ø¥ÙÙ†Ù’ Ø´ÙØ§Ø¡Ù Ø§Ù„Ù„ÙÙ‘Ù‡Ù",
            "Ø§Ø³ØªØºÙØ± Ø§Ù„Ù„Ù‡": "Ø£ÙØ³Ù’ØªÙØºÙ’ÙÙØ±Ù Ø§Ù„Ù„ÙÙ‘Ù‡Ù",
            "Ø§Ù„Ù„Ù‡": "Ø§Ù„Ù„ÙÙ‘Ù‡Ù",
            "Ù…Ø­Ù…Ø¯": "Ù…ÙØ­ÙÙ…ÙÙ‘Ø¯ÙŒ",
            "Ø¹Ù„ÙŠ": "Ø¹ÙÙ„ÙÙŠÙŒÙ‘",
            "Ø­Ø³Ù†": "Ø­ÙØ³ÙÙ†ÙŒ",
            "Ø­Ø³ÙŠÙ†": "Ø­ÙØ³ÙÙŠÙ’Ù†ÙŒ",
            "ÙØ§Ø·Ù…Ø©": "ÙÙØ§Ø·ÙÙ…ÙØ©Ù",
            "Ù‚Ø±Ø§Ù†": "Ù‚ÙØ±Ù’Ø¢Ù†",
            "Ø§Ù„Ù‚Ø±Ø¢Ù†": "Ø§Ù„Ù’Ù‚ÙØ±Ù’Ø¢Ù†",
            "Ø¯Ø¹Ø§Ø¡": "Ø¯ÙØ¹ÙØ§Ø¡",
            "ØµÙ„Ø§Ø©": "ØµÙÙ„ÙØ§Ø©"
        };

        // Embedded Knowledge Base for Reflections
        const reflectionDictionary = {
            "allah": "The supreme name of God. Root: A-L-H. Denotes the One who is worshipped and to whom all creation submits.",
            "Ø§Ù„Ù„Ù‡": "The supreme name of God. Root: A-L-H. Denotes the One who is worshipped and to whom all creation submits.",
            "salam": "Root: S-L-M. Denotes peace, safety, and submission. It is one of the foundational Names of Allah (As-Salam).",
            "Ø³Ù„Ø§Ù…": "Root: S-L-M. Denotes peace, safety, and submission. It is one of the foundational Names of Allah (As-Salam).",
            "bismillah": "Root: S-M-W (Name) and A-L-H (God). The invocation of grace and beginning all actions through Divine permission.",
            "Ø¨Ø³Ù… Ø§Ù„Ù„Ù‡": "Root: S-M-W (Name) and A-L-H (God). The invocation of grace and beginning all actions through Divine permission.",
            "alhamdulillah": "Root: H-M-D. Encompasses both intense praise and absolute gratitude. It recognizes that all perfection and blessings originate exclusively from the Creator.",
            "Ø§Ù„Ø­Ù…Ø¯ Ù„Ù„Ù‡": "Root: H-M-D. Encompasses both intense praise and absolute gratitude. It recognizes that all perfection and blessings originate exclusively from the Creator.",
            "muhammad": "Root: H-M-D. The intensely praised one. The name of the final Messenger (saw).",
            "Ù…Ø­Ù…Ø¯": "Root: H-M-D. The intensely praised one. The name of the final Messenger (saw).",
            "ali": "Root: '-L-W. The exalted, the high. Represents spiritual elevation and profound truth.",
            "Ø¹Ù„ÙŠ": "Root: '-L-W. The exalted, the high. Represents spiritual elevation and profound truth.",
            "husayn": "Root: H-S-N. The diminutive form of Hasan, meaning 'the beautiful one' in inner character and outer form.",
            "Ø­Ø³ÙŠÙ†": "Root: H-S-N. The diminutive form of Hasan, meaning 'the beautiful one' in inner character and outer form.",
            "rahmah": "Root: R-H-M. Womb, unconditional grace. The fundamental paradigm of the Creator's interaction with creation."
        };

        // Standard Keyboard Keys
        const keys = [
            '\u064E', '\u064F', '\u0650', '\u0651', '\u0652', '\u064B', '\u064C', '\u064D', '\u0670',
            'Ø¶', 'Øµ', 'Ø«', 'Ù‚', 'Ù', 'Øº', 'Ø¹', 'Ù‡', 'Ø®', 'Ø­', 'Ø¬', 'Ø¯',
            'Ø´', 'Ø³', 'ÙŠ', 'Ø¨', 'Ù„', 'Ø§', 'Øª', 'Ù†', 'Ù…', 'Ùƒ', 'Ø·',
            'Ø¦', 'Ø¡', 'Ø¤', 'Ø±', 'Ù„Ø§', 'Ù‰', 'Ø©', 'Ùˆ', 'Ø²', 'Ø¸', 'Ø°',
            'Ù¡', 'Ù¢', 'Ù£', 'Ù¤', 'Ù¥', 'Ù¦', 'Ù§', 'Ù¨', 'Ù©', 'Ù ',
            'Space', 'Bksp'
        ];

        // Core Fallback Mappings
        const arToEn = { 
            'Ø§': 'a', 'Ø£': 'a', 'Ø¥': 'i', 'Ø¢': 'Ä', 'Ø¨': 'b', 'Øª': 't', 'Ø«': 'th', 'Ø¬': 'j', 'Ø­': 'á¸¥', 'Ø®': 'kh', 'Ø¯': 'd', 'Ø°': 'dh', 'Ø±': 'r', 'Ø²': 'z', 'Ø³': 's', 'Ø´': 'sh', 'Øµ': 'á¹£', 'Ø¶': 'á¸', 'Ø·': 'á¹­', 'Ø¸': 'áº“', 'Ø¹': 'â€˜', 'Øº': 'gh', 'Ù': 'f', 'Ù‚': 'q', 'Ùƒ': 'k', 'Ù„': 'l', 'Ù…': 'm', 'Ù†': 'n', 'Ù‡': 'h', 'Ùˆ': 'w', 'ÙŠ': 'y', 'Ø©': 'h', 'Ù‰': 'Ä', 'Ø¡': "'", 'Ø¦': "'", 'Ø¤': "'", 
            '\u064E': 'a', '\u064F': 'u', '\u0650': 'i', '\u0651': '', '\u0652': '', '\u064B': 'an', '\u064C': 'un', '\u064D': 'in', '\u0670': 'Ä' 
        };
        const chatToAr = { "3'": "Øº", "3*": "Øº", "gh": "Øº", "6'": "Ø¸", "6*": "Ø¸", "zh": "Ø¸", "9'": "Ø¶", "9*": "Ø¶", "dh": "Ø¶", "7'": "Ø®", "7*": "Ø®", "kh": "Ø®", "5": "Ø®", "sh": "Ø´", "ch": "Ø´", "4": "Ø´", "th": "Ø«", "ee": "ÙŠ", "oo": "Ùˆ", "ou": "Ùˆ", "uu": "Ùˆ", "aa": "Ø§", "2": "Ø£", "3": "Ø¹", "6": "Ø·", "7": "Ø­", "8": "Ù‚", "9": "Øµ", "a": "Ø§", "b": "Ø¨", "t": "Øª", "j": "Ø¬", "d": "Ø¯", "r": "Ø±", "z": "Ø²", "s": "Ø³", "f": "Ù", "k": "Ùƒ", "l": "Ù„", "m": "Ù…", "n": "n", "h": "Ù‡", "w": "Ùˆ", "y": "ÙŠ", "i": "ÙŠ", "u": "Ùˆ", "e": "Ø§", "o": "Ùˆ" };

        function setKeyboardTheme(theme) {
            keyboardSection.classList.remove('kb-theme-white', 'kb-theme-black');
            keyboardSection.classList.add('kb-theme-' + theme);
            localStorage.setItem('kb_theme', theme);
        }

        // --- NEW: Local Database Lookups ---
        
        function autoCorrectText() {
            let text = mainInput.value.trim();
            if (!text) return;

            let words = text.split(/\s+/);
            let resultWords = [];
            let i = 0;

            // Sliding window to detect 3-word, 2-word, or 1-word matches in the dictionary
            while(i < words.length) {
                let matchFound = false;
                
                if (i <= words.length - 3) {
                    let phrase = [words[i], words[i+1], words[i+2]].join(" ");
                    if (embeddedDictionary[phrase.toLowerCase()]) {
                        resultWords.push(embeddedDictionary[phrase.toLowerCase()]);
                        i += 3; matchFound = true; continue;
                    }
                }
                
                if (!matchFound && i <= words.length - 2) {
                    let phrase = [words[i], words[i+1]].join(" ");
                    if (embeddedDictionary[phrase.toLowerCase()]) {
                        resultWords.push(embeddedDictionary[phrase.toLowerCase()]);
                        i += 2; matchFound = true; continue;
                    }
                }
                
                if (!matchFound) {
                    let word = words[i].toLowerCase();
                    if (embeddedDictionary[word]) {
                        resultWords.push(embeddedDictionary[word]);
                    } else {
                        resultWords.push(words[i]); // Keep original if no match
                    }
                    i++;
                }
            }

            mainInput.value = resultWords.join(" ");
            process(); // Trigger UI updates
        }

        function localReflectText() {
            const input = mainInput.value.toLowerCase();
            if(!input.trim()) return;

            let reflection = "No specific linguistic root found for this phrase in the offline dictionary. Try inputting foundational words like 'Allah', 'Bismillah', 'Salam', or 'Alhamdulillah'.";

            // Search input string against keys in our local reflection database
            for (const key in reflectionDictionary) {
                if (input.includes(key)) {
                    reflection = reflectionDictionary[key];
                    break;
                }
            }

            aiInsightsContent.innerText = reflection;
            aiInsightsContainer.classList.remove('hidden');
        }

        // --- Native Browser Voice (100% Free, Offline) ---
        function speakTextNative() {
            const input = outputArabicEditable.value.trim() || mainInput.value.trim();
            if(!input) return;

            window.speechSynthesis.cancel();
            const utterance = new SpeechSynthesisUtterance(input);
            utterance.lang = 'ar-SA'; 
            utterance.rate = 0.85; 
            
            let voices = window.speechSynthesis.getVoices();
            if(voices.length !== 0) {
                 window.speechSynthesis.speak(utterance);
            } else {
                 window.speechSynthesis.onvoiceschanged = () => {
                     window.speechSynthesis.speak(utterance);
                 };
            }
        }

        // --- Core Deterministic Engine ---
        function performFormalTransliteration(text) {
            let res = "";
            for (let i = 0; i < text.length; i++) {
                const char = text[i], next = text[i+1];
                if (next === '\u0651') { res += (arToEn[char] || "") + (arToEn[char] || ""); i++; continue; }
                if (char === 'Ø§' && next === 'Ù„' && (i === 0 || text[i-1] === ' ')) { res += "al-"; i++; continue; }
                const translated = arToEn[char];
                res += (translated !== undefined) ? translated : char;
            }
            return res.charAt(0).toUpperCase() + res.slice(1);
        }

        function process() {
            const text = mainInput.value;
            if (!text.trim()) { 
                output1.value = "Waiting..."; 
                outputArabicEditable.value = ""; 
                return; 
            }

            if (currentMode === 'standard' || currentMode === 'quran') {
                if(translationContainer.classList.contains('hidden')) {
                    outputArabicEditable.value = text;
                    output1.value = performFormalTransliteration(text);
                }
            } else {
                let arabicBuild = "";
                text.split(/(\s+)/).forEach((part) => {
                    if (!part) return;
                    if (/\s+/.test(part)) { arabicBuild += part; return; }
                    arabicBuild += convertWordToArabic(part.toLowerCase());
                });
                outputArabicEditable.value = arabicBuild;
                output1.value = performFormalTransliteration(arabicBuild);
            }
        }

        function updateTranslitFromArabicEdit() { 
            output1.value = performFormalTransliteration(outputArabicEditable.value); 
        }

        function convertWordToArabic(word) {
            let w = "", j = 0;
            const sortedKeys = Object.keys(chatToAr).sort((a, b) => b.length - a.length);
            if (word.startsWith('al-')) { w += "Ø§Ù„"; j = 3; }
            while(j < word.length) {
                let matched = false;
                for (const key of sortedKeys) { 
                    if (word.substr(j, key.length) === key) { 
                        w += chatToAr[key]; j += key.length; matched = true; break; 
                    } 
                }
                if (!matched) { w += word[j]; j++; }
            }
            return w;
        }

        // --- Free Public API Integration (Alquran.cloud) ---
        async function handleUnifiedSearch() {
            const query = document.getElementById('quranKeyword').value.trim();
            if (!query) return;
            apiLoading.classList.remove('hidden');
            document.getElementById('apiLoadingText').innerText = "Fetching Divine Verses...";
            
            try {
                const refMatch = query.match(/^(\d+):(\d+)$/);
                if (refMatch) {
                    const response = await fetch(`https://api.alquran.cloud/v1/ayah/${query}/editions/quran-uthmani,en.transliteration,en.sahih`);
                    const data = await response.json();
                    if(data.code === 200) {
                        mainInput.value = data.data[0].text;
                        outputArabicEditable.value = data.data[0].text;
                        output1.value = data.data[1].text; 
                        outputTranslation.innerText = data.data[2].text; 
                        
                        translationContainer.classList.remove('hidden');
                        quranResults.classList.add('hidden');
                    }
                } else {
                    const response = await fetch(`https://api.alquran.cloud/v1/search/${query}/all/en.sahih`);
                    const data = await response.json();
                    quranResults.innerHTML = "";
                    if(data.code === 200 && data.data.matches.length > 0) {
                        quranResults.classList.remove('hidden');
                        data.data.matches.slice(0, 10).forEach(m => {
                            const div = document.createElement('div');
                            div.className = "p-4 rounded-2xl border border-emerald-100 cursor-pointer text-xs mb-2 transition-all bg-white hover:border-emerald-500 shadow-sm";
                            div.innerHTML = `<div class="font-black text-emerald-700 uppercase">${m.surah.englishName} (${m.surah.number}:${m.numberInSurah})</div><p class="text-slate-600 line-clamp-2">${m.text}</p>`;
                            div.onclick = () => { document.getElementById('quranKeyword').value = `${m.surah.number}:${m.numberInSurah}`; handleUnifiedSearch(); };
                            quranResults.appendChild(div);
                        });
                    } else {
                        quranResults.classList.remove('hidden');
                        quranResults.innerHTML = "<div class='text-sm text-slate-500 text-center p-4'>No results found.</div>";
                    }
                }
            } catch (e) {
                console.error(e);
            } finally { 
                apiLoading.classList.add('hidden'); 
            }
        }

        async function fetchQuranMetadata() {
            try {
                const response = await fetch('https://api.alquran.cloud/v1/surah');
                const data = await response.json();
                surahData = data.data;
                const sSelect = document.getElementById('pickSurah');
                sSelect.innerHTML = '<option value="">Select Surah</option>';
                surahData.forEach(s => { sSelect.innerHTML += `<option value="${s.number}">${s.number}. ${s.englishName}</option>`; });
                const jSelect = document.getElementById('pickJuz');
                jSelect.innerHTML = '<option value="">Select Juz</option>';
                for(let i=1; i<=30; i++) { jSelect.innerHTML += `<option value="${i}">Juz ${i}</option>`; }
            } catch (e) {
                console.error("Failed to load Surah metadata");
            }
        }

        function handleJuzChange() { const juz = document.getElementById('pickJuz').value; if(juz) fetchVerseByRef(`juz/${juz}/quran-uthmani`); }
        function handleSurahChange() {
            const surahNum = document.getElementById('pickSurah').value;
            const aSelect = document.getElementById('pickAyah');
            aSelect.innerHTML = '<option value="">Ayah</option>';
            if(!surahNum) return;
            const s = surahData.find(x => x.number == surahNum);
            for(let i=1; i<=s.numberOfAyahs; i++) { aSelect.innerHTML += `<option value="${i}">${i}</option>`; }
        }
        function handleAyahChange() {
            const surah = document.getElementById('pickSurah').value;
            const ayah = document.getElementById('pickAyah').value;
            if(surah && ayah) fetchVerseByRef(`${surah}:${ayah}`);
        }
        async function fetchVerseByRef(ref) { document.getElementById('quranKeyword').value = ref; handleUnifiedSearch(); }

        // --- App Lifecycle ---
        function setMode(mode) {
            currentMode = mode;
            document.querySelectorAll('[id^="mode"]').forEach(b => b.classList.remove('active-tab'));
            document.getElementById('mode' + mode.charAt(0).toUpperCase() + mode.slice(1)).classList.add('active-tab');
            document.getElementById('quranPickContainer').classList.toggle('hidden', mode !== 'quran');
            mainInput.style.textAlign = (mode === 'arabizi') ? 'left' : 'right';
            mainInput.setAttribute('dir', (mode === 'arabizi') ? 'ltr' : 'rtl');
            process();
        }

        function initKeyboard() {
            keyboardGrid.innerHTML = "";
            keys.forEach(key => {
                const btn = document.createElement('button');
                let fontSize = "text-xl sm:text-3xl"; 
                if (key === 'Space' || key === 'Bksp') fontSize = "text-[10px] uppercase tracking-tighter";
                if (key === 'Ù„Ø§') fontSize = "text-lg";
                btn.className = `keyboard-key p-2 sm:p-3 rounded-xl font-bold shadow-sm ${fontSize}`;
                btn.innerText = key;
                btn.onclick = () => {
                    const s = mainInput.selectionStart, v = mainInput.value;
                    if (key === 'Bksp') { mainInput.value = v.substring(0, Math.max(0, s - 1)) + v.substring(s); mainInput.selectionStart = mainInput.selectionEnd = Math.max(0, s - 1); }
                    else if (key === 'Space') { mainInput.value = v.substring(0, s) + ' ' + v.substring(s); mainInput.selectionStart = mainInput.selectionEnd = s + 1; }
                    else { mainInput.value = v.substring(0, s) + key + v.substring(s); mainInput.selectionStart = mainInput.selectionEnd = s + key.length; }
                    mainInput.focus(); process();
                };
                keyboardGrid.appendChild(btn);
            });
            setKeyboardTheme(localStorage.getItem('kb_theme') || 'white');
        }

        function pasteText() { navigator.clipboard.readText().then(t => { mainInput.value += t; process(); }).catch(() => alert("Paste manually with Ctrl+V")); }
        function clearText(t) {
            if(t === 'input') { mainInput.value = ""; outputArabicEditable.value = ""; process(); translationContainer.classList.add('hidden'); }
            else { output1.value = "Waiting..."; outputTranslation.innerText = ""; translationContainer.classList.add('hidden'); }
        }
        function copyText(id) {
            const el = document.getElementById(id);
            const val = el.tagName === 'TEXTAREA' ? el.value : el.innerText;
            if(!val || val === "Waiting...") return;
            const temp = document.createElement('textarea'); temp.value = val; document.body.appendChild(temp); temp.select(); document.execCommand('copy'); document.body.removeChild(temp);
            document.getElementById('copyBadge').classList.remove('hidden'); setTimeout(() => document.getElementById('copyBadge').classList.add('hidden'), 2000);
        }

        window.addEventListener('load', () => { 
            initKeyboard(); 
            fetchQuranMetadata(); 
            setMode('standard'); 
        });
        
        mainInput.addEventListener('input', () => {
            translationContainer.classList.add('hidden'); 
            process();
        });
    </script>
</body>
</html>
